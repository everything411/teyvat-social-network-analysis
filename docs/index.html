<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æç“¦ç‰¹è§’è‰²å…³ç³»ç½‘ç»œåˆ†æå™¨</title>
<style>
:root{--bg-color:#f4f7f9;--card-bg:#fff;--primary-text:#333;--secondary-text:#666;--border-color:#e0e0e0;--accent-color:#007bff;--accent-hover:#0056b3}
body{font-family:'Helvetica Neue',Arial,'Hiragino Sans GB','Microsoft YaHei',sans-serif;background-color:var(--bg-color);color:var(--primary-text);line-height:1.6;margin:0;padding:20px}
.container{max-width:1600px;margin:auto;display:flex;flex-direction:column;gap:20px}
.card{background-color:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:25px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
h1,h2,h3{color:var(--primary-text);border-bottom:2px solid var(--border-color);padding-bottom:10px;margin-top:0}
h1{font-size:2em}h2{font-size:1.5em}h3{font-size:1.2em;border-bottom:none}
button{padding:12px 25px;font-size:16px;font-weight:bold;background-color:var(--accent-color);color:#fff;border:none;border-radius:8px;cursor:pointer;transition:background-color .2s ease,transform .1s ease}
button:disabled{background-color:#ccc;cursor:not-allowed}
button:not(:disabled):hover{background-color:var(--accent-hover);transform:translateY(-1px)}
.output-container{display:grid;grid-template-columns:3fr 2fr;gap:20px;min-height:80vh}
#network-visualization{width:100%;height:800px;background-color:#222;border:1px solid #d3d3d3;position:relative}
.analysis-panel{overflow-y:auto;height:80vh;padding-right:15px}
.analysis-panel::-webkit-scrollbar{width:8px}
.analysis-panel::-webkit-scrollbar-track{background:#f1f1f1}
.analysis-panel::-webkit-scrollbar-thumb{background:#ccc;border-radius:4px}
.analysis-panel::-webkit-scrollbar-thumb:hover{background:#aaa}
table{width:100%;border-collapse:collapse;margin:20px 0}
th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border-color)}
th{background-color:#f9f9f9;font-weight:bold}
.community-list{padding-left:0;list-style:none}
.community-list li{background:#f9f9f9;padding:12px;border-radius:6px;margin-bottom:8px;border-left:4px solid var(--accent-color)}
.loader{border:5px solid #f3f3f3;border-top:5px solid var(--accent-color);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
@media(max-width:1024px){.output-container{grid-template-columns:1fr}#network-visualization{height:60vh}.analysis-panel{height:auto;max-height:70vh}}
</style>
<link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet">
</head>
<body>
<div class="container">
  <div class="card"><h1>æç“¦ç‰¹è§’è‰²å…³ç³»ç½‘ç»œåˆ†æå™¨</h1></div>
  <div id="output-section" class="card">
    <div class="output-container">
      <div id="network-visualization"></div>
      <div id="analysis-results" class="analysis-panel"></div>
    </div>
  </div>
</div>
<script type="module">
import Graph from 'https://cdn.jsdelivr.net/npm/graphology/+esm';
import louvain from 'https://cdn.jsdelivr.net/npm/graphology-communities-louvain/+esm';
import betweennessCentrality from 'https://cdn.jsdelivr.net/npm/graphology-metrics/centrality/betweenness.js/+esm';
import { Network } from 'https://cdn.jsdelivr.net/npm/vis-network/peer/esm/vis-network.min.js/+esm';
import { DataSet } from 'https://cdn.jsdelivr.net/npm/vis-data@8.0.3/peer/esm/vis-data.js/+esm';

const resultsDiv = document.getElementById('analysis-results');
const vizContainer = document.getElementById('network-visualization');

async function fetchAndDecompress(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`åŠ è½½å¤±è´¥: ${url}`);
  const blob = await res.blob();
  const decompressed = await new Response(blob.stream().pipeThrough(new DecompressionStream('gzip'))).blob();
  return JSON.parse(await decompressed.text());
}

function loadAvatarIdToName(avatarData, textMap) {
  const avatarIdToName = {};
  avatarData.forEach(avatar => {
    const textHash = String(avatar.nameTextMapHash || '');
    if (textMap[textHash]) avatarIdToName[avatar.id] = textMap[textHash];
  });
  return avatarIdToName;
}

function buildMentionGraph(fettersData, textMap, avatarIdToName) {
  const graph = new Graph({ type: 'directed' });
  const aliasMap = {"ä»†äºº":"é˜¿è•¾å¥‡è¯º","å…¬å­":"è¾¾è¾¾åˆ©äºš","æ•£å…µ":"æµæµªè€…","å°å‰ç¥¥è‰ç‹":"çº³è¥¿å¦²","å°†å†›":"é›·ç”µå°†å†›","ç¥å­":"å…«é‡ç¥å­"};
  const allAvatarNames = new Set(Object.values(avatarIdToName));
  const allMentionNames = new Set([...allAvatarNames, ...Object.keys(aliasMap)]);

  fettersData.forEach(voiceEntry => {
    const avatarId = voiceEntry.avatarId;
    if (!avatarId || !avatarIdToName[avatarId]) return;
    const speakerName = avatarIdToName[avatarId];
    if (speakerName === "æ—…è¡Œè€…") return;
    const voiceTitle = textMap[String(voiceEntry.voiceTitleTextMapHash)] || '';
    if (!voiceTitle) return;
    graph.mergeNode(speakerName);
    allMentionNames.forEach(name => {
      if (name !== speakerName && voiceTitle.includes(name)) {
        const mentionedName = aliasMap[name] || name;
        if (allAvatarNames.has(mentionedName)) {
          graph.mergeNode(mentionedName);
          graph.mergeEdge(speakerName, mentionedName);
        }
      }
    });
  });
  return graph;
}

function analyzeGraph(graph) {
  const inDegrees = [], outDegrees = [];
  graph.forEachNode(node => {
    inDegrees.push({ id: node, degree: graph.inDegree(node) });
    outDegrees.push({ id: node, degree: graph.outDegree(node) });
  });
  const betweenness = betweennessCentrality(graph);
  louvain.assign(graph);
  return {
    nNodes: graph.order,
    nEdges: graph.size,
    density: graph.density,
    topInDegree: inDegrees.sort((a,b)=>b.degree-a.degree).slice(0,5),
    topOutDegree: outDegrees.sort((a,b)=>b.degree-a.degree).slice(0,5),
    topBetweenness: Object.entries(betweenness).map(([id,v])=>({id,value:v})).sort((a,b)=>b.value-a.value).slice(0,5),
    communities: (()=>{
      const communities = {};
      graph.forEachNode((node, attrs)=>{
        const commId = attrs.community;
        if (!communities[commId]) communities[commId] = [];
        communities[commId].push(node);
      });
      return Object.values(communities).sort((a,b)=>b.length-a.length);
    })()
  };
}

function renderResults(results) {
  resultsDiv.innerHTML = `
    <h2>åˆ†ææŠ¥å‘Š</h2>
    <h3>åŸºæœ¬æŒ‡æ ‡</h3>
    <table>
      <tr><th>æŒ‡æ ‡</th><th>å€¼</th></tr>
      <tr><td>è§’è‰²æ•° (èŠ‚ç‚¹)</td><td>${results.nNodes}</td></tr>
      <tr><td>è¯„ä»·å…³ç³»æ•° (è¾¹)</td><td>${results.nEdges}</td></tr>
      <tr><td>ç½‘ç»œå¯†åº¦</td><td>${results.density}</td></tr>
      <tr><td>ç¤¾åŒºæ•°é‡</td><td>${results.communities.length}</td></tr>
    </table>
    ${createCentralityTable('ğŸ† æœ€å—æ¬¢è¿ (å…¥åº¦Top 5)', results.topInDegree, 'degree', 'å…¥åº¦')}
    ${createCentralityTable('ğŸ“¢ æœ€æ´»è·ƒ (å‡ºåº¦Top 5)', results.topOutDegree, 'degree', 'å‡ºåº¦')}
    ${createCentralityTable('ğŸ”— æœ€å…·å½±å“åŠ› (ä¸­ä»‹ä¸­å¿ƒæ€§Top 5)', results.topBetweenness, 'value', 'ä¸­å¿ƒæ€§')}
    <h3>ç¤¾åŒºåˆ’åˆ† (Top 10)</h3>
    <ul class="community-list">
      ${results.communities.slice(0,10).map((c,i)=>
        `<li><strong>ç¤¾åŒº ${i+1} (${c.length}å):</strong> ${c.join(', ')}</li>`).join('')}
      ${results.communities.length>10?`<li>... è¿˜æœ‰ ${results.communities.length-10} ä¸ªå°ç¤¾åŒº</li>`:''}
    </ul>`;
}

function createCentralityTable(title, data, valueKey, valueLabel) {
  return `<h3>${title}</h3>
    <table>
      <tr><th>æ’å</th><th>è§’è‰²</th><th>${valueLabel}</th></tr>
      ${data.map((item,i)=>
        `<tr><td>${i+1}</td><td>${item.id}</td><td>${item[valueKey]}</td></tr>`).join('')}
    </table>`;
}

function renderVisualization(graph) {
  const nodes = new DataSet(), edges = new DataSet();
  graph.forEachNode((node, attrs) => {
    nodes.add({
      id: node,
      label: node,
      group: attrs.community,
      title: `è§’è‰²ï¼š ${node} ç¤¾åŒº: ${attrs.community} å…¥åº¦: ${graph.inDegree(node)} å‡ºåº¦: ${graph.outDegree(node)}`
    });
  });
  graph.forEachEdge((edge, attrs, source, target) => {
    edges.add({ from: source, to: target, arrows: 'to' });
  });
  const options = {
    edges: { color: { inherit: true }, smooth: { enabled: true, type: "dynamic" } },
    interaction: { dragNodes: true },
    physics: {
      enabled: true,
      solver: 'barnesHut',
      barnesHut: { gravitationalConstant: -10000, centralGravity: 2, springLength: 150, springConstant: 0.02, damping: 0.5, avoidOverlap: 0.1 },
      stabilization: { enabled: true, iterations: 100, fit: true }
    }
  };
  new Network(vizContainer, { nodes, edges }, options);
}

async function main() {
  try {
    const [textMapData, avatarData, fettersData] = await Promise.all([
      fetchAndDecompress('./TextMapCHS.json.gz'),
      fetchAndDecompress('./AvatarExcelConfigData.json.gz'),
      fetchAndDecompress('./FettersExcelConfigData.json.gz')
    ]);
    const avatarIdToName = loadAvatarIdToName(avatarData, textMapData);
    const graph = buildMentionGraph(fettersData, textMapData, avatarIdToName);
    const analysisResults = analyzeGraph(graph);
    renderResults(analysisResults);
    setTimeout(() => renderVisualization(graph), 100);
  } catch (error) {
    resultsDiv.innerHTML = `<p style="color:#d9534f"><strong>é”™è¯¯:</strong> ${error.message}</p>`;
    console.error(error);
  }
}
main();
</script>
</body>
</html>
